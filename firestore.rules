rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - user profiles
    match /users/{userId} {
      // Anyone can read user profiles (for search, viewing others)
      allow read: if true;
      
      // Only authenticated users can create their own profile
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Only the owner can update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Only the owner can delete their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Usernames collection - username to userId mapping
    match /usernames/{username} {
      // IMPORTANT: Allow anyone to read (including unauthenticated users)
      // This is needed for checking username availability during registration
      allow read: if true;
      
      // Only authenticated users can create a username mapping
      allow create: if request.auth != null;
      
      // Prevent updates and deletes (usernames should be permanent)
      allow update, delete: if false;
    }
    
    // Locations collection - real-time location tracking
    match /locations/{userId} {
      // Anyone can read locations (for seeing others on map)
      allow read: if true;
      
      // Only the owner can write their location
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User locations collection (alternative name used by location service)
    match /user_locations/{userId} {
      // Anyone can read locations (for seeing others on map)
      allow read: if true;
      
      // Only the owner can write their location
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Connection requests collection
    match /connection_requests/{requestId} {
      // Users can read their own sent or received requests
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.fromUserId || 
         request.auth.uid == resource.data.toUserId);
      
      // Authenticated users can create connection requests
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.fromUserId;
      
      // Only the recipient can update (accept/reject) the request
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.toUserId;
      
      // Users can delete their own sent requests
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.fromUserId;
    }
    
    // Friendships collection
    match /friendships/{friendshipId} {
      // Users can read friendships they're part of
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId1 || 
         request.auth.uid == resource.data.userId2);
      
      // System creates friendships (via cloud function or client after accepting request)
      allow create: if request.auth != null;
      
      // Users can delete friendships they're part of (unfriend)
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.userId1 || 
         request.auth.uid == resource.data.userId2);
      
      // Prevent updates (friendships are created and deleted, not updated)
      allow update: if false;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
